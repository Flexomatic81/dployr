# Dployr - Complete Infrastructure
# Start all services with: docker compose up -d

services:
  # MariaDB Database
  mariadb:
    image: mariadb:11
    container_name: dployr-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD must be set}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./infrastructure/mariadb/init:/docker-entrypoint-initdb.d:ro
      - ./infrastructure/mariadb/conf:/etc/mysql/conf.d:ro
    networks:
      - dployr-network
    ports:
      - "127.0.0.1:3306:3306"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # phpMyAdmin for database management
  phpmyadmin:
    image: phpmyadmin:5
    container_name: dployr-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mariadb
      PMA_PORT: 3306
      UPLOAD_LIMIT: 256M
    networks:
      - dployr-network
    ports:
      - "${PHPMYADMIN_PORT:-8080}:80"
    depends_on:
      mariadb:
        condition: service_healthy

  # PostgreSQL Database
  postgresql:
    image: postgres:16-alpine
    container_name: dployr-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD:?POSTGRES_ROOT_PASSWORD must be set}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    networks:
      - dployr-network
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin for PostgreSQL management
  pgadmin:
    image: dpage/pgadmin4:8
    container_name: dployr-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@local.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?PGADMIN_PASSWORD must be set}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - dployr-network
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      postgresql:
        condition: service_healthy

  # Nginx Proxy Manager (optional - controlled via Dashboard Admin Panel)
  npm:
    image: jc21/nginx-proxy-manager:2
    container_name: dployr-npm
    restart: unless-stopped
    environment:
      DISABLE_IPV6: "true"
      # Initial admin credentials (only used on first start)
      INITIAL_ADMIN_EMAIL: ${NPM_API_EMAIL:-}
      INITIAL_ADMIN_PASSWORD: ${NPM_API_PASSWORD:-}
    ports:
      - "${NPM_HTTP_PORT:-80}:80"
      - "${NPM_HTTPS_PORT:-443}:443"
      - "${NPM_ADMIN_PORT:-81}:81"
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
    networks:
      - dployr-network
    healthcheck:
      test: ["CMD", "/bin/check-health"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Web Dashboard
  dashboard:
    build:
      context: ./dashboard
      args:
        GIT_HASH: ${GIT_HASH:-unknown}
        GIT_DATE: ${GIT_DATE:-unknown}
    container_name: dployr-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Dployr root directory (for updates via git pull)
      - ${HOST_DPLOYR_PATH:-/opt/dployr}:${HOST_DPLOYR_PATH:-/opt/dployr}
      # User projects (both paths for Docker socket compatibility)
      - ./users:/app/users
      - ${HOST_USERS_PATH:-/opt/dployr/users}:${HOST_USERS_PATH:-/opt/dployr/users}
      # Scripts and templates
      - ./scripts:/app/scripts:ro
      - ./templates:/app/templates:ro
      - ./infrastructure:/app/infrastructure
      # Root .env file for dynamic config updates
      - ./.env:/app/.env
    environment:
      - NODE_ENV=production
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-dashboard}
      - DB_USERNAME=${DB_USERNAME:-dashboard_user}
      - DB_PASSWORD=${DB_PASSWORD:-}
      - SESSION_SECRET=${SESSION_SECRET:?SESSION_SECRET must be set}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - POSTGRES_ROOT_PASSWORD=${POSTGRES_ROOT_PASSWORD}
      - SERVER_IP=${SERVER_IP:-localhost}
      - USERS_PATH=/app/users
      - HOST_USERS_PATH=${HOST_USERS_PATH:-/opt/dployr/users}
      - SCRIPTS_PATH=/app/scripts
      - TEMPLATES_PATH=/app/templates
      # Nginx Proxy Manager (optional)
      - NPM_ENABLED=${NPM_ENABLED:-false}
      - NPM_API_URL=${NPM_API_URL:-http://dployr-npm:81/api}
      - NPM_API_EMAIL=${NPM_API_EMAIL:-}
      - NPM_API_PASSWORD=${NPM_API_PASSWORD:-}
      # Dployr installation path (for updates)
      - HOST_DPLOYR_PATH=${HOST_DPLOYR_PATH:-/opt/dployr}
    networks:
      - dployr-network
    depends_on:
      mariadb:
        condition: service_healthy

networks:
  dployr-network:
    name: dployr-network
    driver: bridge

volumes:
  mariadb_data:
    name: dployr-mariadb-data
  postgresql_data:
    name: dployr-postgresql-data
  pgadmin_data:
    name: dployr-pgadmin-data
  npm_data:
    name: dployr-npm-data
  npm_letsencrypt:
    name: dployr-npm-letsencrypt
