version: '3.8'

# Deployr - Komplette Infrastruktur
# Startet alle Services mit: docker compose up -d

services:
  # MariaDB Datenbank
  mariadb:
    image: mariadb:11
    container_name: deployr-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD muss gesetzt sein}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./infrastructure/mariadb/init:/docker-entrypoint-initdb.d:ro
      - ./infrastructure/mariadb/conf:/etc/mysql/conf.d:ro
    networks:
      - deployr-network
    ports:
      - "127.0.0.1:3306:3306"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # phpMyAdmin für Datenbank-Verwaltung
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: deployr-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mariadb
      PMA_PORT: 3306
      UPLOAD_LIMIT: 256M
    networks:
      - deployr-network
    ports:
      - "${PHPMYADMIN_PORT:-8080}:80"
    depends_on:
      mariadb:
        condition: service_healthy

  # Web Dashboard
  dashboard:
    build: ./dashboard
    container_name: deployr-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    volumes:
      # Docker Socket für Container-Management
      - /var/run/docker.sock:/var/run/docker.sock
      # User-Projekte
      - ./users:/app/users
      # Scripts und Templates
      - ./scripts:/app/scripts:ro
      - ./templates:/app/templates:ro
      - ./infrastructure:/app/infrastructure
      - ./config.sh:/app/config.sh
    environment:
      - NODE_ENV=production
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-dashboard}
      - DB_USERNAME=${DB_USERNAME:-dashboard_user}
      - DB_PASSWORD=${DB_PASSWORD:-}
      - SESSION_SECRET=${SESSION_SECRET:?SESSION_SECRET muss gesetzt sein}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - USERS_PATH=/app/users
      - SCRIPTS_PATH=/app/scripts
      - TEMPLATES_PATH=/app/templates
    networks:
      - deployr-network
    depends_on:
      mariadb:
        condition: service_healthy

networks:
  deployr-network:
    name: deployr-network
    driver: bridge

volumes:
  mariadb_data:
    name: deployr-mariadb-data
