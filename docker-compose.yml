# Dployr - Komplette Infrastruktur
# Startet alle Services mit: docker compose up -d

services:
  # MariaDB Datenbank
  mariadb:
    image: mariadb:11
    container_name: dployr-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD muss gesetzt sein}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./infrastructure/mariadb/init:/docker-entrypoint-initdb.d:ro
      - ./infrastructure/mariadb/conf:/etc/mysql/conf.d:ro
    networks:
      - dployr-network
    ports:
      - "127.0.0.1:3306:3306"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # phpMyAdmin für Datenbank-Verwaltung
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: dployr-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mariadb
      PMA_PORT: 3306
      UPLOAD_LIMIT: 256M
    networks:
      - dployr-network
    ports:
      - "${PHPMYADMIN_PORT:-8080}:80"
    depends_on:
      mariadb:
        condition: service_healthy

  # PostgreSQL Datenbank
  postgresql:
    image: postgres:16-alpine
    container_name: dployr-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD:?POSTGRES_ROOT_PASSWORD muss gesetzt sein}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    networks:
      - dployr-network
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin für PostgreSQL-Verwaltung
  pgadmin:
    image: dpage/pgadmin4:8
    container_name: dployr-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@local.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?PGADMIN_PASSWORD muss gesetzt sein}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - dployr-network
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      postgresql:
        condition: service_healthy

  # Web Dashboard
  dashboard:
    build: ./dashboard
    container_name: dployr-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    volumes:
      # Docker Socket für Container-Management
      - /var/run/docker.sock:/var/run/docker.sock
      # User-Projekte (beide Pfade für Kompatibilität mit Docker-Socket)
      - ./users:/app/users
      - ${HOST_USERS_PATH:-/opt/dployr/users}:${HOST_USERS_PATH:-/opt/dployr/users}
      # Scripts und Templates
      - ./scripts:/app/scripts:ro
      - ./templates:/app/templates:ro
      - ./infrastructure:/app/infrastructure
    environment:
      - NODE_ENV=production
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-dashboard}
      - DB_USERNAME=${DB_USERNAME:-dashboard_user}
      - DB_PASSWORD=${DB_PASSWORD:-}
      - SESSION_SECRET=${SESSION_SECRET:?SESSION_SECRET muss gesetzt sein}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - POSTGRES_ROOT_PASSWORD=${POSTGRES_ROOT_PASSWORD}
      - SERVER_IP=${SERVER_IP:-localhost}
      - USERS_PATH=/app/users
      - HOST_USERS_PATH=${HOST_USERS_PATH:-/opt/dployr/users}
      - SCRIPTS_PATH=/app/scripts
      - TEMPLATES_PATH=/app/templates
    networks:
      - dployr-network
    depends_on:
      mariadb:
        condition: service_healthy

networks:
  dployr-network:
    name: dployr-network
    driver: bridge

volumes:
  mariadb_data:
    name: dployr-mariadb-data
  postgresql_data:
    name: dployr-postgresql-data
  pgadmin_data:
    name: dployr-pgadmin-data
