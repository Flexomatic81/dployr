<%- include('../partials/pageHeader', {
    title: workspace.project_name,
    titleIcon: 'bi-code-square',
    breadcrumbs: [
        { label: t('workspaces:title'), href: '/workspaces' },
        { label: workspace.project_name }
    ]
}) %>

<div class="row">
    <!-- Workspace Info -->
    <div class="col-md-8">
        <div class="card d-elevated mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    <%= t('common:labels.status') %>
                </h5>
                <% let statusBadge = 'secondary'; %>
                <% if (workspace.status === 'running') statusBadge = 'success'; %>
                <% if (workspace.status === 'starting') statusBadge = 'info'; %>
                <% if (workspace.status === 'error') statusBadge = 'danger'; %>
                <span class="badge bg-<%= statusBadge %> fs-6">
                    <%= t('workspaces:status.' + workspace.status) %>
                </span>
            </div>
            <div class="card-body">
                <% if (workspace.error_message) { %>
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <%= workspace.error_message %>
                    </div>
                <% } %>

                <dl class="row mb-0">
                    <dt class="col-sm-4"><%= t('common:labels.project') %></dt>
                    <dd class="col-sm-8">
                        <a href="/projects/<%= workspace.project_name %>">
                            <%= workspace.project_name %>
                        </a>
                    </dd>

                    <% if (workspace.assigned_port) { %>
                    <dt class="col-sm-4"><%= t('workspaces:info.port') %></dt>
                    <dd class="col-sm-8"><code><%= workspace.assigned_port %></code></dd>
                    <% } %>

                    <% if (workspace.started_at) { %>
                    <dt class="col-sm-4"><%= t('workspaces:info.runningFor') %></dt>
                    <dd class="col-sm-8">
                        <%= new Date(workspace.started_at).toLocaleString(currentLanguage) %>
                    </dd>
                    <% } %>

                    <% if (workspace.last_activity) { %>
                    <dt class="col-sm-4"><%= t('workspaces:info.lastActivity') %></dt>
                    <dd class="col-sm-8">
                        <%= new Date(workspace.last_activity).toLocaleString(currentLanguage) %>
                    </dd>
                    <% } %>

                    <dt class="col-sm-4"><%= t('common:labels.created') %></dt>
                    <dd class="col-sm-8">
                        <%= new Date(workspace.created_at).toLocaleString(currentLanguage) %>
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Actions -->
        <div class="card d-elevated">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i>
                    <%= t('common:labels.actions') %>
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <% if (workspace.status === 'stopped') { %>
                        <button class="btn btn-success" onclick="startWorkspace(this)">
                            <i class="bi bi-play-fill"></i>
                            <%= t('workspaces:actions.start') %>
                        </button>
                    <% } else if (workspace.status === 'running') { %>
                        <button class="btn btn-primary" id="openIdeBtn" onclick="openIDE(this)">
                            <i class="bi bi-code-square"></i>
                            <%= t('workspaces:actions.openIDE') %>
                        </button>
                        <button class="btn btn-claude" id="openClaudeBtn" onclick="openClaude(this)">
                            <i class="bi bi-robot"></i>
                            <%= t('workspaces:actions.openClaude') %>
                        </button>
                        <button class="btn btn-dark" id="openTerminalBtn" onclick="openTerminal(this)">
                            <i class="bi bi-terminal"></i>
                            <%= t('workspaces:actions.openTerminal') %>
                        </button>
                        <button class="btn btn-warning" onclick="stopWorkspace(this)">
                            <i class="bi bi-stop-fill"></i>
                            <%= t('workspaces:actions.stop') %>
                        </button>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Resource Limits -->
        <div class="card d-elevated mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-speedometer"></i>
                    <%= t('workspaces:settings.resourceLimits') %>
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0 small">
                    <dt class="col-6"><%= t('workspaces:settings.cpu') %></dt>
                    <dd class="col-6"><code><%= workspace.cpu_limit %></code></dd>

                    <dt class="col-6"><%= t('workspaces:settings.ram') %></dt>
                    <dd class="col-6"><code><%= workspace.ram_limit.replace(/(\d+)g/i, '$1 GB').replace(/(\d+)m/i, '$1 MB') %></code></dd>

                    <dt class="col-6"><%= t('workspaces:settings.disk') %></dt>
                    <dd class="col-6"><code><%= workspace.disk_limit.replace(/(\d+)g/i, '$1 GB').replace(/(\d+)m/i, '$1 MB') %></code></dd>

                    <dt class="col-6"><%= t('workspaces:settings.idleTimeout') %></dt>
                    <dd class="col-6"><%= workspace.idle_timeout_minutes %> min</dd>
                </dl>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="card d-elevated border-danger">
            <div class="card-header bg-danger-subtle">
                <h5 class="mb-0 text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <%= t('common:labels.dangerZone') %>
                </h5>
            </div>
            <div class="card-body">
                <button class="btn btn-danger w-100" onclick="deleteWorkspace()">
                    <i class="bi bi-trash"></i>
                    <%= t('workspaces:actions.delete') %>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
async function startWorkspace(btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Starting...';

    try {
        const response = await fetch('/workspaces/<%= workspace.project_name %>/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': '<%= csrfToken %>'
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to start workspace');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> <%= t("workspaces:actions.start") %>';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-fill"></i> <%= t("workspaces:actions.start") %>';
    }
}

async function stopWorkspace(btn) {
    if (!confirm('<%= t("common:confirm.action") %>')) return;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Stopping...';

    try {
        const response = await fetch('/workspaces/<%= workspace.project_name %>/stop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': '<%= csrfToken %>'
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to stop workspace');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stop-fill"></i> <%= t("workspaces:actions.stop") %>';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stop-fill"></i> <%= t("workspaces:actions.stop") %>';
    }
}

async function deleteWorkspace() {
    if (!confirm('<%= t("common:confirm.delete") %>')) return;

    try {
        const response = await fetch('/workspaces/<%= workspace.project_name %>', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': '<%= csrfToken %>'
            }
        });

        const data = await response.json();

        if (data.success) {
            window.location.href = '/workspaces';
        } else {
            alert(data.error || 'Failed to delete workspace');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function openTerminal(btn) {
    const originalContent = btn.innerHTML;

    // Open tab immediately to avoid popup blocker
    const terminalWindow = window.open('about:blank', '_blank');

    if (!terminalWindow) {
        // Popup was blocked - fall back to direct navigation
        window.location.href = '/workspaces/<%= workspace.project_name %>/terminal';
        return;
    }

    // Show a loading message in the new tab
    terminalWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Loading Terminal...</title>
            <style>
                body {
                    background: #1e1e1e;
                    color: #ccc;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                }
                .loader {
                    text-align: center;
                }
                .spinner {
                    border: 4px solid #333;
                    border-top: 4px solid #0e639c;
                    border-radius: 50%;
                    width: 50px;
                    height: 50px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </head>
        <body>
            <div class="loader">
                <div class="spinner"></div>
                <p id="status"><%= t("workspaces:ide.waitingForContainer") %></p>
            </div>
        </body>
        </html>
    `);

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> <%= t("workspaces:ide.waitingForContainer") %>';

    // Wait for container to be healthy
    const maxAttempts = 30;
    let attempts = 0;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch('/workspaces/<%= workspace.project_name %>/health');
            const data = await response.json();

            if (data.healthy) {
                // Container is ready, navigate the already-open tab to Terminal
                terminalWindow.location.href = '/workspaces/<%= workspace.project_name %>/terminal';
                btn.disabled = false;
                btn.innerHTML = originalContent;
                return;
            }

            // Update status in both button and new tab
            if (data.status === 'starting') {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> <%= t("workspaces:ide.containerStarting") %>';
                try {
                    terminalWindow.document.getElementById('status').textContent = '<%= t("workspaces:ide.containerStarting") %>';
                } catch (e) { /* Tab might be closed */ }
            }
        } catch (error) {
            console.error('Health check failed:', error);
        }

        attempts++;
        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    // Timeout - navigate anyway
    terminalWindow.location.href = '/workspaces/<%= workspace.project_name %>/terminal';
    btn.disabled = false;
    btn.innerHTML = originalContent;
}

async function openClaude(btn) {
    const originalContent = btn.innerHTML;

    // Open tab immediately to avoid popup blocker
    const claudeWindow = window.open('about:blank', '_blank');

    if (!claudeWindow) {
        // Popup was blocked - fall back to direct navigation
        window.location.href = '/workspaces/<%= workspace.project_name %>/claude';
        return;
    }

    // Show a loading message in the new tab
    claudeWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Loading Claude Code...</title>
            <style>
                body {
                    background: linear-gradient(135deg, #1e1e1e 0%, #2d1f3d 100%);
                    color: #ccc;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                }
                .loader {
                    text-align: center;
                }
                .spinner {
                    border: 4px solid #333;
                    border-top: 4px solid #6b46c1;
                    border-radius: 50%;
                    width: 50px;
                    height: 50px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                .claude-logo {
                    width: 60px;
                    height: 60px;
                    background: linear-gradient(135deg, #6b46c1, #9f7aea);
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 28px;
                    color: #fff;
                    margin: 0 auto 20px;
                }
            </style>
        </head>
        <body>
            <div class="loader">
                <div class="claude-logo">C</div>
                <div class="spinner"></div>
                <p id="status"><%= t("workspaces:claude.loading") %></p>
            </div>
        </body>
        </html>
    `);

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> <%= t("workspaces:ide.waitingForContainer") %>';

    // Wait for container to be healthy
    const maxAttempts = 30;
    let attempts = 0;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch('/workspaces/<%= workspace.project_name %>/health');
            const data = await response.json();

            if (data.healthy) {
                // Container is ready, navigate the already-open tab to Claude
                claudeWindow.location.href = '/workspaces/<%= workspace.project_name %>/claude';
                btn.disabled = false;
                btn.innerHTML = originalContent;
                return;
            }

            // Update status in both button and new tab
            if (data.status === 'starting') {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> <%= t("workspaces:ide.containerStarting") %>';
                try {
                    claudeWindow.document.getElementById('status').textContent = '<%= t("workspaces:ide.containerStarting") %>';
                } catch (e) { /* Tab might be closed */ }
            }
        } catch (error) {
            console.error('Health check failed:', error);
        }

        attempts++;
        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    // Timeout - navigate anyway
    claudeWindow.location.href = '/workspaces/<%= workspace.project_name %>/claude';
    btn.disabled = false;
    btn.innerHTML = originalContent;
}

async function openIDE(btn) {
    const originalContent = btn.innerHTML;

    // Open tab immediately to avoid popup blocker
    // Browser allows window.open() only in direct response to user click
    const ideWindow = window.open('about:blank', '_blank');

    if (!ideWindow) {
        // Popup was blocked - fall back to direct navigation
        window.location.href = '/workspaces/<%= workspace.project_name %>/ide';
        return;
    }

    // Show a loading message in the new tab
    ideWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Loading IDE...</title>
            <style>
                body {
                    background: #1e1e1e;
                    color: #ccc;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                }
                .loader {
                    text-align: center;
                }
                .spinner {
                    border: 4px solid #333;
                    border-top: 4px solid #0e639c;
                    border-radius: 50%;
                    width: 50px;
                    height: 50px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </head>
        <body>
            <div class="loader">
                <div class="spinner"></div>
                <p id="status"><%= t("workspaces:ide.waitingForContainer") %></p>
            </div>
        </body>
        </html>
    `);

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> <%= t("workspaces:ide.waitingForContainer") %>';

    // Wait for container to be healthy
    const maxAttempts = 30;
    let attempts = 0;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch('/workspaces/<%= workspace.project_name %>/health');
            const data = await response.json();

            if (data.healthy) {
                // Container is ready, navigate the already-open tab to IDE
                ideWindow.location.href = '/workspaces/<%= workspace.project_name %>/ide';
                btn.disabled = false;
                btn.innerHTML = originalContent;
                return;
            }

            // Update status in both button and new tab
            if (data.status === 'starting') {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> <%= t("workspaces:ide.containerStarting") %>';
                try {
                    ideWindow.document.getElementById('status').textContent = '<%= t("workspaces:ide.containerStarting") %>';
                } catch (e) { /* Tab might be closed */ }
            }
        } catch (error) {
            console.error('Health check failed:', error);
        }

        attempts++;
        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    // Timeout - navigate anyway
    ideWindow.location.href = '/workspaces/<%= workspace.project_name %>/ide';
    btn.disabled = false;
    btn.innerHTML = originalContent;
}
</script>
