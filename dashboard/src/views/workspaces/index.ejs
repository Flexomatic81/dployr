<%- include('../partials/pageHeader', {
    title: t('workspaces:title'),
    titleIcon: 'bi-code-square',
    subtitle: t('workspaces:subtitle')
}) %>

<div class="d-table-shell">
    <%- include('../components/tableShell', {
        title: t('workspaces:title'),
        titleIcon: 'bi-code-square'
    }) %>
    <div class="d-table-shell-body">
        <% if (workspaces.length === 0) { %>
            <%- include('../components/emptyState', {
                title: t('workspaces:info.noWorkspaces'),
                description: t('workspaces:info.createFirst'),
                icon: 'bi-code-square',
                primaryAction: { href: '/projects', label: t('common:nav.projects'), icon: 'bi-folder' }
            }) %>
        <% } else { %>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th><%= t('common:labels.project') %></th>
                            <th><%= t('common:labels.status') %></th>
                            <th><%= t('workspaces:info.runningFor') %></th>
                            <th><%= t('workspaces:info.lastActivity') %></th>
                            <th class="text-end"><%= t('common:labels.actions') %></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% workspaces.forEach(workspace => { %>
                            <tr<% if (workspace.orphaned) { %> class="table-warning"<% } %>>
                                <td>
                                    <% if (workspace.orphaned) { %>
                                        <i class="bi bi-exclamation-triangle text-warning"></i>
                                        <strong><%= workspace.project_name %></strong>
                                    <% } else { %>
                                        <a href="/workspaces/<%= workspace.project_name %>" class="text-decoration-none">
                                            <i class="bi bi-code-square text-primary"></i>
                                            <strong><%= workspace.project_name %></strong>
                                        </a>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (workspace.orphaned) { %>
                                        <span class="badge bg-warning-subtle text-warning" title="<%= t('workspaces:errors.orphaned') %>">
                                            <%= t('workspaces:status.orphaned') %>
                                        </span>
                                    <% } else { %>
                                        <% let statusBadge = 'secondary'; %>
                                        <% if (workspace.status === 'running') statusBadge = 'success'; %>
                                        <% if (workspace.status === 'starting') statusBadge = 'info'; %>
                                        <% if (workspace.status === 'error') statusBadge = 'danger'; %>
                                        <span class="badge bg-<%= statusBadge %>-subtle text-<%= statusBadge %>">
                                            <%= t('workspaces:status.' + workspace.status) %>
                                        </span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (workspace.started_at) { %>
                                        <small class="text-muted">
                                            <%= new Date(workspace.started_at).toLocaleString(currentLanguage) %>
                                        </small>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (workspace.last_activity) { %>
                                        <small class="text-muted">
                                            <%= new Date(workspace.last_activity).toLocaleString(currentLanguage) %>
                                        </small>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                    <% } %>
                                </td>
                                <td class="text-end">
                                    <% if (workspace.orphaned) { %>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-workspace-id="<%= workspace.id %>"
                                                data-workspace-name="<%= workspace.project_name %>">
                                            <i class="bi bi-trash"></i>
                                            <%= t('workspaces:actions.delete') %>
                                        </button>
                                    <% } else { %>
                                        <% if (workspace.status === 'running') { %>
                                            <a href="/workspaces/<%= workspace.project_name %>/ide"
                                               class="btn btn-sm btn-primary" target="_blank">
                                                <i class="bi bi-box-arrow-up-right"></i>
                                                <%= t('workspaces:actions.openIDE') %>
                                            </a>
                                        <% } %>
                                        <a href="/workspaces/<%= workspace.project_name %>"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-gear"></i>
                                        </a>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>
</div>

<% if (workspaces.some(w => w.orphaned)) { %>
<script nonce="<%= cspNonce %>">
async function deleteOrphanedWorkspace(workspaceId, projectName) {
    if (!confirm('<%= t("common:confirm.delete") %>')) return;

    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch('/workspaces/orphaned/' + workspaceId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to delete workspace');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

document.querySelectorAll('.btn-outline-danger[data-workspace-id]').forEach(function(btn) {
    btn.addEventListener('click', function() {
        deleteOrphanedWorkspace(
            parseInt(this.dataset.workspaceId),
            this.dataset.workspaceName
        );
    });
});
</script>
<% } %>
