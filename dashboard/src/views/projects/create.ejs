<!-- Page Header -->
<%- include('../partials/pageHeader', {
    title: t('projects:createNew'),
    titleIcon: 'bi-plus-circle',
    backLink: { href: '/projects', label: t('common:nav.projects') }
}) %>

<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <!-- Tabs for creation method -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="git-tab" data-bs-toggle="tab" data-bs-target="#git-content" type="button">
                    <i class="bi bi-git"></i> <%= t('projects:create.fromGit') %>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="zip-tab" data-bs-toggle="tab" data-bs-target="#zip-content" type="button">
                    <i class="bi bi-file-earmark-zip"></i> <%= t('projects:create.fromZip') %>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-content" type="button">
                    <i class="bi bi-file-earmark-code"></i> <%= t('projects:create.fromTemplate') %>
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Tab: From Git -->
            <div class="tab-pane fade show active" id="git-content" role="tabpanel">
                <div class="card d-elevated">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-git"></i> <%= t('projects:create.gitTitle') %></h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/projects/from-git">
                            <div class="mb-3">
                                <label for="git_name" class="form-label">
                                    <%= t('projects:create.projectName') %>
                                    <%- include('../partials/help-icon', { text: t('projects:create.projectNameHelp') }) %>
                                </label>
                                <input type="text" class="form-control" id="git_name" name="name"
                                       pattern="[a-z0-9-]+" required
                                       title="<%= t('projects:create.projectNameHint') %>"
                                       placeholder="<%= t('projects:create.projectNamePlaceholder') %>">
                                <div class="form-text"><%= t('projects:create.projectNameHint') %></div>
                            </div>

                            <div class="mb-3">
                                <label for="repo_url" class="form-label">
                                    <%= t('projects:create.repoUrl') %>
                                    <%- include('../partials/help-icon', { text: t('projects:create.repoUrlHelp') }) %>
                                </label>
                                <input type="url" class="form-control" id="repo_url" name="repo_url" required
                                       placeholder="https://github.com/username/repository">
                                <div class="form-text"><%= t('projects:create.repoUrlHint') %></div>
                            </div>

                            <div class="mb-3">
                                <label for="access_token" class="form-label">
                                    <%= t('projects:create.accessToken') %> <span class="text-muted"><%= t('projects:create.accessTokenOptional') %></span>
                                    <%- include('../partials/help-icon', { text: t('projects:create.accessTokenHelp') }) %>
                                </label>
                                <input type="password" class="form-control" id="access_token" name="access_token"
                                       placeholder="ghp_... / glpat-... / ATBB...">
                                <div class="form-text">
                                    <%= t('projects:create.accessTokenHint') %>
                                    <span class="ms-1">
                                        <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" class="text-decoration-none me-2" title="GitHub Personal Access Token">
                                            <i class="bi bi-github"></i> <%= t('projects:create.createTokenGithub') %>
                                        </a>
                                        <a href="https://gitlab.com/-/user_settings/personal_access_tokens" target="_blank" class="text-decoration-none me-2" title="GitLab Personal Access Token">
                                            <i class="bi bi-gitlab"></i> <%= t('projects:create.createTokenGitlab') %>
                                        </a>
                                        <a href="https://bitbucket.org/account/settings/app-passwords/" target="_blank" class="text-decoration-none" title="Bitbucket App Password">
                                            <i class="bi bi-bucket"></i> <%= t('projects:create.createTokenBitbucket') %>
                                        </a>
                                    </span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="git_port" class="form-label">
                                    <%= t('common:labels.port') %>
                                    <%- include('../partials/help-icon', { text: t('projects:create.portHelp') }) %>
                                </label>
                                <input type="number" class="form-control" id="git_port" name="port"
                                       value="<%= nextPort %>" min="8001" max="9999" required>
                                <div class="form-text"><%= t('projects:create.nextFreePort', { port: nextPort }) %></div>
                            </div>

                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong><%= t('projects:create.autoDetection') %></strong> <%= t('projects:create.autoDetectionInfo') %>
                                <ul class="mb-0 mt-2">
                                    <li><%= t('projects:create.autoDetectNode') %></li>
                                    <li><%= t('projects:create.autoDetectPhp') %></li>
                                    <li><%= t('projects:create.autoDetectStatic') %></li>
                                </ul>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-git"></i> <%= t('projects:create.submitGit') %>
                                </button>
                                <a href="/projects" class="btn btn-outline-secondary">
                                    <%= t('common:buttons.cancel') %>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab: From ZIP -->
            <div class="tab-pane fade" id="zip-content" role="tabpanel">
                <div class="card d-elevated">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-file-earmark-zip"></i> <%= t('projects:create.zipTitle') %></h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/projects/from-zip" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="zip_name" class="form-label"><%= t('projects:create.projectName') %></label>
                                <input type="text" class="form-control" id="zip_name" name="name"
                                       pattern="[a-z0-9-]+" required
                                       title="<%= t('projects:create.projectNameHint') %>"
                                       placeholder="<%= t('projects:create.projectNamePlaceholder') %>">
                                <div class="form-text"><%= t('projects:create.projectNameHint') %></div>
                            </div>

                            <div class="mb-3">
                                <label for="zipfile" class="form-label">
                                    <%= t('projects:create.zipFile') %>
                                    <%- include('../partials/help-icon', { text: t('projects:create.zipFileHelp') }) %>
                                </label>
                                <input type="file" class="form-control" id="zipfile" name="zipfile"
                                       accept=".zip,application/zip" required>
                                <div class="form-text"><%= t('projects:create.zipFileHint') %></div>
                            </div>

                            <div class="mb-4">
                                <label for="zip_port" class="form-label"><%= t('common:labels.port') %></label>
                                <input type="number" class="form-control" id="zip_port" name="port"
                                       value="<%= nextPort %>" min="8001" max="9999" required>
                                <div class="form-text"><%= t('projects:create.nextFreePort', { port: nextPort }) %></div>
                            </div>

                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong><%= t('projects:create.autoDetection') %></strong> <%= t('projects:create.autoDetectionInfo') %>
                                <ul class="mb-0 mt-2">
                                    <li><%= t('projects:create.autoDetectNode') %></li>
                                    <li><%= t('projects:create.autoDetectPhp') %></li>
                                    <li><%= t('projects:create.autoDetectStatic') %></li>
                                </ul>
                            </div>

                            <div class="alert alert-secondary mb-4">
                                <i class="bi bi-folder2-open me-2"></i>
                                <strong><%= t('projects:create.zipStructure') %></strong> <%= t('projects:create.zipStructureInfo') %>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload"></i> <%= t('projects:create.submitZip') %>
                                </button>
                                <a href="/projects" class="btn btn-outline-secondary">
                                    <%= t('common:buttons.cancel') %>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab: From Template -->
            <div class="tab-pane fade" id="template-content" role="tabpanel">
                <div class="card d-elevated">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-folder-plus"></i> <%= t('projects:create.templateTitle') %></h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/projects">
                            <div class="mb-3">
                                <label for="name" class="form-label"><%= t('projects:create.projectName') %></label>
                                <input type="text" class="form-control" id="name" name="name"
                                       pattern="[a-z0-9-]+" required
                                       title="<%= t('projects:create.projectNameHint') %>"
                                       placeholder="<%= t('projects:create.projectNamePlaceholder') %>">
                                <div class="form-text"><%= t('projects:create.projectNameHint') %></div>
                            </div>

                            <div class="mb-3">
                                <label for="template" class="form-label">
                                    <%= t('projects:create.template') %>
                                    <%- include('../partials/help-icon', { text: t('projects:create.templateHelp') }) %>
                                </label>
                                <select class="form-select" id="template" name="template" required>
                                    <% templates.forEach(template => { %>
                                        <option value="<%= template.name %>"><%= template.displayName %></option>
                                    <% }) %>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label for="port" class="form-label"><%= t('common:labels.port') %></label>
                                <input type="number" class="form-control" id="port" name="port"
                                       value="<%= nextPort %>" min="8001" max="9999" required>
                                <div class="form-text"><%= t('projects:create.nextFreePort', { port: nextPort }) %></div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus-lg"></i> <%= t('projects:create.submitTemplate') %>
                                </button>
                                <a href="/projects" class="btn btn-outline-secondary">
                                    <%= t('common:buttons.cancel') %>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Template Info (only visible on Template tab) -->
        <div class="card d-elevated mt-4" id="template-info-card" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> <%= t('projects:templateInfo.title') %></h5>
            </div>
            <div class="card-body">
                <div class="accordion accordion-flush" id="templateInfo">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#staticInfo">
                                <i class="bi bi-file-earmark-code me-2"></i> <%= t('projects:templateInfo.static.title') %>
                            </button>
                        </h2>
                        <div id="staticInfo" class="accordion-collapse collapse" data-bs-parent="#templateInfo">
                            <div class="accordion-body">
                                <ul class="mb-0">
                                    <% t('projects:templateInfo.static.features', { returnObjects: true }).forEach(feature => { %>
                                        <li><%= feature %></li>
                                    <% }) %>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#phpInfo">
                                <i class="bi bi-filetype-php me-2"></i> <%= t('projects:templateInfo.php.title') %>
                            </button>
                        </h2>
                        <div id="phpInfo" class="accordion-collapse collapse" data-bs-parent="#templateInfo">
                            <div class="accordion-body">
                                <ul class="mb-0">
                                    <% t('projects:templateInfo.php.features', { returnObjects: true }).forEach(feature => { %>
                                        <li><%= feature %></li>
                                    <% }) %>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nodeInfo">
                                <i class="bi bi-filetype-js me-2"></i> <%= t('projects:templateInfo.nodejs.title') %>
                            </button>
                        </h2>
                        <div id="nodeInfo" class="accordion-collapse collapse" data-bs-parent="#templateInfo">
                            <div class="accordion-body">
                                <ul class="mb-0">
                                    <% t('projects:templateInfo.nodejs.features', { returnObjects: true }).forEach(feature => { %>
                                        <li><%= feature %></li>
                                    <% }) %>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Show/hide template info card based on active tab
document.addEventListener('DOMContentLoaded', function() {
    const templateTab = document.getElementById('template-tab');
    const gitTab = document.getElementById('git-tab');
    const zipTab = document.getElementById('zip-tab');
    const templateInfoCard = document.getElementById('template-info-card');

    templateTab.addEventListener('shown.bs.tab', function() {
        templateInfoCard.style.display = 'block';
    });

    gitTab.addEventListener('shown.bs.tab', function() {
        templateInfoCard.style.display = 'none';
    });

    zipTab.addEventListener('shown.bs.tab', function() {
        templateInfoCard.style.display = 'none';
    });

    // Live validation for project name fields
    document.querySelectorAll('input[name="name"]').forEach(function(input) {
        input.addEventListener('input', function() {
            if (this.value && !this.value.match(/^[a-z0-9-]+$/)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Add invalid-feedback element if not present
        if (!input.parentElement.querySelector('.invalid-feedback')) {
            var feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = '<%= t("projects:create.projectNameHint") %>';
            input.parentElement.insertBefore(feedback, input.nextSibling);
        }
    });
});
</script>
