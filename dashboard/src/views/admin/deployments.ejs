<%- include('../partials/pageHeader', {
    title: t('admin:deployments.title'),
    titleIcon: 'bi-rocket-takeoff',
    backLink: { href: '/admin', label: t('common:nav.admin') }
}) %>

<!-- Statistics (last 24h) -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <%- include('../components/statCard', {
            label: t('admin:deployments.stats.title'),
            value: stats.total || 0,
            variant: 'primary',
            icon: 'bi-rocket-takeoff'
        }) %>
    </div>
    <div class="col-6 col-lg-3">
        <%- include('../components/statCard', {
            label: t('admin:deployments.stats.success'),
            value: stats.successful || 0,
            variant: 'success',
            icon: 'bi-check-circle'
        }) %>
    </div>
    <div class="col-6 col-lg-3">
        <%- include('../components/statCard', {
            label: t('admin:deployments.stats.failed'),
            value: stats.failed || 0,
            variant: 'danger',
            icon: 'bi-x-circle'
        }) %>
    </div>
    <div class="col-6 col-lg-3">
        <%- include('../components/statCard', {
            label: t('admin:deployments.stats.avgDuration'),
            value: stats.avg_duration ? (stats.avg_duration / 1000).toFixed(1) + 's' : '-',
            variant: 'info',
            icon: 'bi-stopwatch'
        }) %>
    </div>
</div>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="/admin/deployments" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="status" class="form-label"><%= t('common:labels.status') %></label>
                <select name="status" id="status" class="form-select">
                    <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>><%= t('admin:logs.levels.all') %></option>
                    <option value="success" <%= filters.status === 'success' ? 'selected' : '' %>><%= t('common:status.success') %></option>
                    <option value="failed" <%= filters.status === 'failed' ? 'selected' : '' %>><%= t('common:status.failed') %></option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="limit" class="form-label"><%= t('common:labels.count') %></label>
                <select name="limit" id="limit" class="form-select">
                    <option value="25" <%= filters.limit === 25 ? 'selected' : '' %>>25</option>
                    <option value="50" <%= filters.limit === 50 ? 'selected' : '' %>>50</option>
                    <option value="100" <%= filters.limit === 100 ? 'selected' : '' %>>100</option>
                    <option value="200" <%= filters.limit === 200 ? 'selected' : '' %>>200</option>
                </select>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel"></i> <%= t('common:buttons.filter') %>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Deployment list -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-list-ul"></i> <%= t('admin:nav.deployments') %> (<%= deployments.length %>)
    </div>
    <div class="card-body p-0">
        <% if (deployments.length === 0) { %>
        <div class="text-center text-muted py-5">
            <i class="bi bi-inbox fs-1"></i>
            <p class="mt-2"><%= t('admin:deployments.noDeployments') %></p>
        </div>
        <% } else { %>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 160px;"><%= t('admin:logs.timestamp') %></th>
                        <th><%= t('admin:deployments.columns.user') %></th>
                        <th><%= t('admin:deployments.columns.project') %></th>
                        <th><%= t('admin:deployments.columns.trigger') %></th>
                        <th style="width: 100px;"><%= t('admin:deployments.columns.status') %></th>
                        <th style="width: 100px;"><%= t('admin:deployments.columns.duration') %></th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <% deployments.forEach((deploy, index) => { %>
                    <tr>
                        <td class="text-muted small">
                            <%= new Date(deploy.deployed_at).toLocaleString(currentLanguage === 'de' ? 'de-DE' : 'en-US') %>
                        </td>
                        <td>
                            <a href="/admin/users/<%= deploy.user_id %>/edit" class="text-decoration-none">
                                <%= deploy.username %>
                            </a>
                            <br>
                            <small class="text-muted"><%= deploy.system_username %></small>
                        </td>
                        <td>
                            <strong><%= deploy.project_name %></strong>
                            <% if (deploy.branch) { %>
                            <br>
                            <small class="text-muted">
                                <i class="bi bi-diagram-2"></i> <%= deploy.branch %>
                            </small>
                            <% } %>
                        </td>
                        <td>
                            <% if (deploy.trigger_type === 'auto') { %>
                            <span class="badge bg-info"><%= t('admin:deployments.triggers.auto') %></span>
                            <% } else if (deploy.trigger_type === 'manual') { %>
                            <span class="badge bg-secondary"><%= t('admin:deployments.triggers.manual') %></span>
                            <% } else if (deploy.trigger_type === 'clone') { %>
                            <span class="badge bg-primary"><%= t('admin:deployments.triggers.clone') %></span>
                            <% } else if (deploy.trigger_type === 'pull') { %>
                            <span class="badge bg-warning text-dark"><%= t('admin:deployments.triggers.pull') %></span>
                            <% } else { %>
                            <span class="badge bg-light text-dark"><%= deploy.trigger_type %></span>
                            <% } %>
                        </td>
                        <td>
                            <% if (deploy.status === 'success') { %>
                            <span class="badge bg-success"><%= t('common:status.success') %></span>
                            <% } else if (deploy.status === 'failed') { %>
                            <span class="badge bg-danger"><%= t('common:status.failed') %></span>
                            <% } else { %>
                            <span class="badge bg-warning text-dark"><%= deploy.status %></span>
                            <% } %>
                        </td>
                        <td class="text-muted">
                            <% if (deploy.duration_ms) { %>
                            <%= (deploy.duration_ms / 1000).toFixed(1) %>s
                            <% } else { %>
                            -
                            <% } %>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary toggle-details" data-index="<%= index %>">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </td>
                    </tr>
                    <tr class="details-row d-none" id="details-<%= index %>">
                        <td colspan="7" style="background-color: var(--bs-tertiary-bg);">
                            <div class="row">
                                <div class="col-md-6">
                                    <% if (deploy.commit_before) { %>
                                    <p class="mb-1">
                                        <strong><%= t('admin:deployments.commitBefore') %>:</strong><br>
                                        <code class="small"><%= deploy.commit_before %></code>
                                    </p>
                                    <% } %>
                                    <% if (deploy.commit_after) { %>
                                    <p class="mb-1">
                                        <strong><%= t('admin:deployments.commitAfter') %>:</strong><br>
                                        <code class="small"><%= deploy.commit_after %></code>
                                    </p>
                                    <% } %>
                                </div>
                                <div class="col-md-6">
                                    <% if (deploy.error_message) { %>
                                    <p class="mb-1">
                                        <strong><%= t('admin:deployments.errorMessage') %>:</strong><br>
                                        <span class="text-danger"><%= deploy.error_message %></span>
                                    </p>
                                    <% } %>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } %>
    </div>
</div>

<script nonce="<%= cspNonce %>">
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.toggle-details').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = this.dataset.index;
            const detailsRow = document.getElementById('details-' + index);
            const icon = this.querySelector('i');

            if (detailsRow.classList.contains('d-none')) {
                detailsRow.classList.remove('d-none');
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else {
                detailsRow.classList.add('d-none');
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
        });
    });
});
</script>
