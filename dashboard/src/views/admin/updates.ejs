<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard"><%= t('common:nav.dashboard') %></a></li>
        <li class="breadcrumb-item"><a href="/admin"><%= t('common:nav.admin') %></a></li>
        <li class="breadcrumb-item active"><%= t('admin:updates.title') %></li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-cloud-download"></i> <%= t('admin:updates.title') %></h1>
</div>

<!-- Version Status -->
<div class="row mb-4 g-3 align-items-stretch">
    <div class="col-md-4">
        <div class="card h-100" id="versionCard">
            <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
                <i class="bi bi-box-seam display-3 text-secondary opacity-50 mb-3" id="versionIcon"></i>
                <h6 class="text-muted mb-2"><%= t('admin:updates.currentVersion') %></h6>
                <span class="fs-5 fw-bold" id="currentVersion">
                    <% if (updateInfo.currentVersion.tag) { %>
                        <%= updateInfo.currentVersion.tag %>
                    <% } else { %>
                        <%= updateInfo.currentVersion.hash %>
                    <% } %>
                </span>
                <small class="text-muted"><%= updateInfo.currentVersion.date %></small>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-muted mb-3"><%= t('admin:updates.status') %></h6>

                <% if (updateInfo.updateAvailable) { %>
                    <!-- Update Available -->
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong><%= t('admin:updates.updateAvailable') %></strong>
                        <% if (updateInfo.latestVersion && updateInfo.latestVersion.tag) { %>
                            - Version <%= updateInfo.latestVersion.tag %>
                        <% } else if (updateInfo.latestVersion && updateInfo.latestVersion.commits) { %>
                            - <%= updateInfo.latestVersion.commits %> <%= t('admin:updates.newCommits') %>
                        <% } %>
                    </div>

                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-success" id="installUpdateBtn">
                            <i class="bi bi-cloud-download"></i> <%= t('admin:updates.installUpdate') %>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="checkUpdatesBtn">
                            <i class="bi bi-arrow-clockwise"></i> <%= t('admin:updates.checkAgain') %>
                        </button>
                        <% if (updateInfo.latestVersion && updateInfo.latestVersion.htmlUrl) { %>
                            <a href="<%= updateInfo.latestVersion.htmlUrl %>" target="_blank" class="btn btn-outline-info">
                                <i class="bi bi-github"></i> <%= t('admin:updates.viewOnGithub') %>
                            </a>
                        <% } %>
                    </div>
                <% } else { %>
                    <!-- Up to Date -->
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong><%= t('admin:updates.upToDate') %></strong>
                    </div>

                    <button type="button" class="btn btn-outline-secondary" id="checkUpdatesBtn">
                        <i class="bi bi-arrow-clockwise"></i> <%= t('admin:updates.checkForUpdates') %>
                    </button>
                <% } %>

                <% if (updateInfo.cached) { %>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-clock-history"></i> <%= t('admin:updates.cachedResult') %>
                    </small>
                <% } %>
            </div>
        </div>
    </div>
</div>

<% if (updateInfo.changelog) { %>
<!-- Changelog -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-journal-text"></i> <%= t('admin:updates.changelog') %>
    </div>
    <div class="card-body">
        <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;"><%= updateInfo.changelog %></pre>
    </div>
</div>
<% } %>

<!-- Update Channel -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-sliders"></i> <%= t('admin:updates.channel') %>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="updateChannel" id="channelStable" value="stable" <%= updateInfo.channel === 'stable' ? 'checked' : '' %>>
                    <label class="form-check-label" for="channelStable">
                        <strong><%= t('admin:updates.channelStable') %></strong>
                        <small class="d-block text-muted"><%= t('admin:updates.channelStableDesc') %></small>
                    </label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="updateChannel" id="channelBeta" value="beta" <%= updateInfo.channel === 'beta' ? 'checked' : '' %>>
                    <label class="form-check-label" for="channelBeta">
                        <strong><%= t('admin:updates.channelBeta') %></strong>
                        <small class="d-block text-muted"><%= t('admin:updates.channelBetaDesc') %></small>
                    </label>
                </div>
            </div>
        </div>
        <div id="channelWarning" class="alert alert-warning mb-0 <%= updateInfo.channel === 'beta' ? '' : 'd-none' %>">
            <i class="bi bi-exclamation-triangle"></i>
            <%= t('admin:updates.channelWarning') %>
        </div>
    </div>
</div>

<!-- Update Info -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-info-circle"></i> <%= t('admin:updates.howItWorks') %>
    </div>
    <div class="card-body">
        <p><%= t('admin:updates.howItWorksDesc') %></p>
        <ol class="mb-0">
            <li><%= t('admin:updates.step1') %></li>
            <li><%= t('admin:updates.step2') %></li>
            <li><%= t('admin:updates.step3') %></li>
            <li><%= t('admin:updates.step4') %></li>
            <li><%= t('admin:updates.step5') %></li>
            <li><%= t('admin:updates.step6') %></li>
        </ol>
        <div class="alert alert-info mt-3 mb-0">
            <i class="bi bi-lightbulb"></i>
            <%= t('admin:updates.note') %>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cloud-download"></i> <%= t('admin:updates.updating') %></h5>
            </div>
            <div class="modal-body">
                <!-- Progress Steps -->
                <div class="mb-4">
                    <div class="d-flex align-items-center mb-2" id="step-pull">
                        <span class="step-icon me-2"><i class="bi bi-hourglass text-muted"></i></span>
                        <span class="step-text">1. <%= t('admin:updates.stepPull') %></span>
                    </div>
                    <div class="d-flex align-items-center mb-2" id="step-images">
                        <span class="step-icon me-2"><i class="bi bi-hourglass text-muted"></i></span>
                        <span class="step-text">2. <%= t('admin:updates.stepImages') %></span>
                    </div>
                    <div class="d-flex align-items-center mb-2" id="step-build">
                        <span class="step-icon me-2"><i class="bi bi-hourglass text-muted"></i></span>
                        <span class="step-text">3. <%= t('admin:updates.stepBuild') %></span>
                    </div>
                    <div class="d-flex align-items-center mb-2" id="step-workspace">
                        <span class="step-icon me-2"><i class="bi bi-hourglass text-muted"></i></span>
                        <span class="step-text">4. <%= t('admin:updates.stepWorkspace') %></span>
                    </div>
                    <div class="d-flex align-items-center mb-2" id="step-restart">
                        <span class="step-icon me-2"><i class="bi bi-hourglass text-muted"></i></span>
                        <span class="step-text">5. <%= t('admin:updates.stepRestart') %></span>
                    </div>
                    <div class="d-flex align-items-center" id="step-ready">
                        <span class="step-icon me-2"><i class="bi bi-hourglass text-muted"></i></span>
                        <span class="step-text">6. <%= t('admin:updates.stepReady') %></span>
                    </div>
                </div>

                <!-- Status Message -->
                <div class="text-center" id="updateStatusContainer">
                    <div class="spinner-border text-primary mb-2" role="status" id="updateSpinner" style="width: 2rem; height: 2rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="updateStatus" class="mb-0"><%= t('admin:updates.pleaseWait') %></p>
                </div>

                <!-- Success Container (hidden initially) -->
                <div class="text-center d-none" id="updateSuccessContainer">
                    <i class="bi bi-check-circle-fill text-success display-4 mb-3"></i>
                    <p class="mb-2"><%= t('admin:updates.updateComplete') %></p>
                    <p class="text-muted small"><%= t('admin:updates.redirecting') %></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="<%= cspNonce %>">
// Check for updates
document.getElementById('checkUpdatesBtn')?.addEventListener('click', async function() {
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> <%= t("common:loading") %>';
    btn.disabled = true;

    try {
        const response = await fetch('/admin/updates/check?force=true', {
            headers: { 'Accept': 'application/json' }
        });
        const result = await response.json();

        if (result.success) {
            // Reload page to show updated info
            window.location.reload();
        } else {
            alert('<%= t("admin:updates.checkFailed") %>: ' + result.error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    } catch (error) {
        alert('<%= t("admin:updates.checkFailed") %>: ' + error.message);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
});

// Helper function to update step status
function setStepStatus(stepId, status) {
    const step = document.getElementById(stepId);
    if (!step) return;

    const icon = step.querySelector('.step-icon');
    if (status === 'active') {
        icon.innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span>';
    } else if (status === 'done') {
        icon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
    } else if (status === 'pending') {
        icon.innerHTML = '<i class="bi bi-hourglass text-muted"></i>';
    }
}

// Install update with SSE progress
document.getElementById('installUpdateBtn')?.addEventListener('click', async function() {
    if (!confirm('<%= t("admin:updates.confirmUpdate") %>')) {
        return;
    }

    const modal = new bootstrap.Modal(document.getElementById('updateModal'));
    modal.show();

    // Reset all steps to pending
    ['step-pull', 'step-images', 'step-build', 'step-workspace', 'step-restart', 'step-ready'].forEach(id => {
        setStepStatus(id, 'pending');
    });

    // Start SSE connection for progress updates
    const eventSource = new EventSource('/admin/updates/install-stream?_csrf=<%= csrfToken %>');

    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);

            // Update steps based on status
            if (data.step === 'pull') {
                setStepStatus('step-pull', 'active');
            } else if (data.step === 'pull-images') {
                setStepStatus('step-pull', 'done');
                setStepStatus('step-images', 'active');
            } else if (data.step === 'build') {
                setStepStatus('step-images', 'done');
                setStepStatus('step-build', 'active');
            } else if (data.step === 'workspace-image') {
                setStepStatus('step-build', 'done');
                setStepStatus('step-workspace', 'active');
            } else if (data.step === 'restart') {
                setStepStatus('step-build', 'done');
                setStepStatus('step-workspace', 'done');
                setStepStatus('step-restart', 'active');
            } else if (data.status === 'complete') {
                setStepStatus('step-restart', 'done');
                setStepStatus('step-ready', 'active');
                document.getElementById('updateStatus').textContent = '<%= t("admin:updates.restartingDashboard") %>';
                eventSource.close();
                // Now wait for dashboard to come back online
                waitForDashboardReady();
            }

            if (data.error) {
                eventSource.close();
                document.getElementById('updateStatus').textContent = '<%= t("admin:updates.updateFailed") %>: ' + data.error;
                document.getElementById('updateSpinner').classList.add('d-none');
            }
        } catch (e) {
            console.error('Error parsing SSE data:', e);
        }
    };

    eventSource.onerror = function() {
        // Connection lost - dashboard probably restarting
        eventSource.close();
        // Mark all previous steps as done (connection lost means deploy script finished)
        setStepStatus('step-pull', 'done');
        setStepStatus('step-images', 'done');
        setStepStatus('step-build', 'done');
        setStepStatus('step-workspace', 'done');
        setStepStatus('step-restart', 'done');
        setStepStatus('step-ready', 'active');
        document.getElementById('updateStatus').textContent = '<%= t("admin:updates.restartingDashboard") %>';
        waitForDashboardReady();
    };
});

// Wait for dashboard to come back online after restart
async function waitForDashboardReady() {
    let phase = 'waiting-offline'; // First wait for dashboard to go offline
    let attempts = 0;
    let successCount = 0;
    const maxAttempts = 180; // 3 minutes max
    const requiredSuccesses = 5; // Require 5 consecutive successful health checks before redirect

    const checkInterval = setInterval(async () => {
        attempts++;

        try {
            const response = await fetch('/health', {
                method: 'GET',
                cache: 'no-store',
                signal: AbortSignal.timeout(2000) // 2 second timeout
            });

            if (response.ok) {
                if (phase === 'waiting-offline') {
                    // Dashboard is still running, keep waiting for it to go offline
                    successCount = 0;
                } else {
                    // Phase: waiting-online - dashboard is coming back
                    successCount++;
                    if (successCount >= requiredSuccesses) {
                        clearInterval(checkInterval);
                        // Show success state briefly, then redirect
                        setStepStatus('step-ready', 'done');
                        document.getElementById('updateStatusContainer').classList.add('d-none');
                        document.getElementById('updateSuccessContainer').classList.remove('d-none');
                        // Auto-redirect to login after short delay
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 1000);
                    }
                }
            } else {
                // Non-OK response - dashboard is restarting
                if (phase === 'waiting-offline') {
                    phase = 'waiting-online';
                }
                successCount = 0;
            }
        } catch {
            // Connection error - dashboard is offline/restarting
            if (phase === 'waiting-offline') {
                phase = 'waiting-online';
            }
            successCount = 0;
        }

        if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            document.getElementById('updateSpinner').classList.add('d-none');
            document.getElementById('updateStatus').innerHTML = '<%= t("admin:updates.manualRefresh") %>';
        }
    }, 1000);
}

// Update channel selection
document.querySelectorAll('input[name="updateChannel"]').forEach(radio => {
    radio.addEventListener('change', async function() {
        const channel = this.value;
        const warning = document.getElementById('channelWarning');

        try {
            const response = await fetch('/admin/updates/channel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRF-Token': '<%= csrfToken %>'
                },
                body: JSON.stringify({ channel })
            });

            const result = await response.json();

            if (result.success) {
                // Show/hide warning based on channel
                if (channel === 'beta') {
                    warning.classList.remove('d-none');
                } else {
                    warning.classList.add('d-none');
                }
                // Reload page to check for updates with new channel
                window.location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
});
</script>
